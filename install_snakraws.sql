DROP TABLE IF EXISTS snakraws_blacklist;
DROP TABLE IF EXISTS snakraws_factevents;
DROP TABLE IF EXISTS snakraws_dimcities;
DROP TABLE IF EXISTS snakraws_dimcontinents;
DROP TABLE IF EXISTS snakraws_dimcountries;
DROP TABLE IF EXISTS snakraws_dimdevices;
DROP TABLE IF EXISTS snakraws_dimuseragents;
DROP TABLE IF EXISTS snakraws_dimhosts;
DROP TABLE IF EXISTS snakraws_dimips;
DROP TABLE IF EXISTS snakraws_dimregions;
DROP TABLE IF EXISTS snakraws_dimpostalcodes;
DROP TABLE IF EXISTS snakraws_dimreferers;
DROP TABLE IF EXISTS snakraws_shorturls;
DROP TABLE IF EXISTS snakraws_longurls;

create table snakraws_dimcities (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  name             VARCHAR(100) NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimcities  (hash, name, is_mutable)
VALUES (5298596870147225945, 'unknown', FALSE);
INSERT INTO snakraws_dimcities  (hash, name, is_mutable)
VALUES (-8478403668358870585, 'missing', FALSE);
INSERT INTO snakraws_dimcities  (hash, name, is_mutable)
VALUES (-3750763034362895579, '', FALSE);

create table snakraws_dimregions (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  name             VARCHAR(100) NOT NULL UNIQUE,
  code             CHAR(2)      NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimregions  (hash, name, code, is_mutable)
VALUES (5298596870147225945, 'unknown', '??', FALSE);
INSERT INTO snakraws_dimregions  (hash, name, code, is_mutable)
VALUES (-8478403668358870585, 'missing', '!!', FALSE);
INSERT INTO snakraws_dimregions  (hash, name, code, is_mutable)
VALUES (-3750763034362895579, '', '--', FALSE);

create table snakraws_dimpostalcodes (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  postalcode       VARCHAR(32)  NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimpostalcodes (hash, postalcode, is_mutable)
VALUES (5298596870147225945, 'unknown', FALSE);
INSERT INTO snakraws_dimpostalcodes (hash, postalcode, is_mutable)
VALUES (-8478403668358870585, 'missing', FALSE);
INSERT INTO snakraws_dimpostalcodes (hash, postalcode, is_mutable)
VALUES (-3750763034362895579, '', FALSE);

create table snakraws_dimcountries (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  name             VARCHAR(100) NOT NULL UNIQUE,
  code             CHAR(2)      NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimcountries  (hash, name, code, is_mutable)
VALUES (5298596870147225945, 'unknown', '??', FALSE);
INSERT INTO snakraws_dimcountries  (hash, name, code, is_mutable)
VALUES (-8478403668358870585, 'missing', '!!', FALSE);
INSERT INTO snakraws_dimcountries  (hash, name, code, is_mutable)
VALUES (-3750763034362895579, '', '--', FALSE);

create table snakraws_dimcontinents (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  name             VARCHAR(100) NOT NULL UNIQUE,
  code             CHAR(2)      NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimcontinents  (hash, name, code, is_mutable)
VALUES (5298596870147225945, 'unknown', '??', FALSE);
INSERT INTO snakraws_dimcontinents  (hash, name, code, is_mutable)
VALUES (-8478403668358870585, 'missing', '!!', FALSE);
INSERT INTO snakraws_dimcontinents  (hash, name, code, is_mutable)
VALUES (-3750763034362895579, '', '--', FALSE);

create table snakraws_dimdevices (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  deviceid         VARCHAR(40)  NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimdevices (hash, deviceid, is_mutable)
VALUES (5298596870147225945, 'unknown', FALSE);
INSERT INTO snakraws_dimdevices (hash, deviceid, is_mutable)
VALUES (-8478403668358870585, 'missing', FALSE);
INSERT INTO snakraws_dimdevices (hash, deviceid, is_mutable)
VALUES (-3750763034362895579, '', FALSE);

create table snakraws_dimuseragents (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  useragent        VARCHAR(8192) NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimuseragents (hash, useragent, is_mutable)
VALUES (5298596870147225945, 'unknown', FALSE);
INSERT INTO snakraws_dimuseragents (hash, useragent, is_mutable)
VALUES (-8478403668358870585, 'missing', FALSE);
INSERT INTO snakraws_dimuseragents (hash, useragent, is_mutable)
VALUES (-3750763034362895579, '', FALSE);

create table snakraws_dimhosts (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  hostname         VARCHAR(253) NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimhosts  (hash, hostname, is_mutable)
VALUES (5298596870147225945, 'unknown', FALSE);
INSERT INTO snakraws_dimhosts  (hash, hostname, is_mutable)
VALUES (-8478403668358870585, 'missing', FALSE);
INSERT INTO snakraws_dimhosts  (hash, hostname, is_mutable)
VALUES (-3750763034362895579, '', FALSE);

create table snakraws_dimips (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  ip               VARCHAR(39)  NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimips (hash, ip, is_mutable)
VALUES (5298596870147225945, 'unknown', FALSE);
INSERT INTO snakraws_dimips (hash, ip, is_mutable)
VALUES (-8478403668358870585, 'missing', FALSE);
INSERT INTO snakraws_dimips (hash, ip, is_mutable)
VALUES (-3750763034362895579, '', FALSE);

create table snakraws_dimreferers (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  hash             BIGINT       NOT NULL UNIQUE,
  referer          VARCHAR(1024) NOT NULL UNIQUE,
  is_mutable BOOLEAN      NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_dimreferers (hash, referer, is_mutable)
VALUES (5298596870147225945, 'unknown', FALSE);
INSERT INTO snakraws_dimreferers (hash, referer, is_mutable)
VALUES (-8478403668358870585, 'missing', FALSE);
INSERT INTO snakraws_dimreferers (hash, referer, is_mutable)
VALUES (-3750763034362895579, '', FALSE);

create table snakraws_longurls (
    id                  INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    hash                BIGINT NOT NULL UNIQUE,
    longurl             VARCHAR(4096) NOT NULL,
    originally_encoded  BOOLEAN NOT NULL DEFAULT FALSE,
    is_active           BOOLEAN NOT NULL DEFAULT TRUE
);

INSERT INTO snakraws_longurls (id, hash, longurl, is_active)
VALUES (0, 4967328134902799212, 'unspecified', TRUE);

create table snakraws_shorturls (
    id                  INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    longurl_id          INT NOT NULL UNIQUE,
    hash                BIGINT NOT NULL UNIQUE,
    shorturl            VARCHAR(40) NOT NULL,
    shorturl_path_size  SMALLINT NULL,
    compression_ratio   DECIMAL(10,2) NULL,
    is_active           BOOLEAN NOT NULL DEFAULT TRUE
);

CREATE UNIQUE INDEX IX_snakraws_shorturls_is_active_longurl_id
ON snakraws_shorturls (is_active, longurl_id);

INSERT INTO snakraws_shorturls (id, longurl_id, hash, shorturl, shorturl_path_size, is_active)
VALUES (0, 0, 4967328134902799212, 'unspecified', NULL, TRUE);

ALTER TABLE snakraws_shorturls
ADD CONSTRAINT fk_snakraws_shorturls_longurl_id
FOREIGN KEY (longurl_id) REFERENCES snakraws_longurls (id) ON DELETE CASCADE;

create table snakraws_factevents (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  event_yyyymmdd   CHAR(8) DEFAULT TO_CHAR(CURRENT_TIMESTAMP, 'YYYYMMDD') NOT NULL,
  event_hhmiss     CHAR(6) DEFAULT TO_CHAR(CURRENT_TIMESTAMP, 'HH24MISS') NOT NULL,
  event_type       CHAR(1) NOT NULL CHECK (event_type IN ('B','D','E','I','L','N','R','S','U','W','X','Z')),
  http_status_code SMALLINT                                           NOT NULL,
  info             VARCHAR(8192)                                      NOT NULL,
  longurl_id       INT                                                NOT NULL,
  shorturl_id      INT                                                NOT NULL,
  city_id          INT                                                NOT NULL,
  region_id        INT                                                NOT NULL,
  postalcode_id    INT                                                NOT NULL,
  country_id       INT                                                NOT NULL,
  continent_id     INT                                                NOT NULL,
  device_id        INT                                                NOT NULL,
  host_id          INT                                                NOT NULL,
  referer_id       INT                                                NOT NULL,
  ip_id            INT                                                NOT NULL,
  useragent_id     INT                                                NOT NULL
);

CREATE INDEX IX_snakraws_factevents_shorturl  ON snakraws_factevents
  (shorturl_id);

CREATE INDEX IX_snakraws_factevents_longurl  ON snakraws_factevents
  (longurl_id);

CREATE INDEX IX_snakraws_factevents_yyyymmdd_hhmiss ON snakraws_factevents
  (event_yyyymmdd, event_hhmiss);

CREATE INDEX IX_snakraws_factevents_type_yyyymmdd_hhmiss ON snakraws_factevents
  (event_type, event_yyyymmdd, event_hhmiss);

CREATE INDEX IX_snakraws_factevents_city
ON snakraws_factevents
  (city_id);

CREATE INDEX IX_snakraws_factevents_continent
ON snakraws_factevents
  (continent_id);

CREATE INDEX IX_snakraws_factevents_country
ON snakraws_factevents
  (country_id);

CREATE INDEX IX_snakraws_factevents_device
ON snakraws_factevents
  (device_id);

CREATE INDEX IX_snakraws_factevents_host
ON snakraws_factevents
  (host_id);

CREATE INDEX IX_snakraws_factevents_ip
ON snakraws_factevents
  (ip_id);

CREATE INDEX IX_snakraws_factevents_postalcode
ON snakraws_factevents
  (postalcode_id);

CREATE INDEX IX_snakraws_factevents_referer
ON snakraws_factevents
  (referer_id);

CREATE INDEX IX_snakraws_factevents_region
ON snakraws_factevents
  (region_id);

CREATE INDEX IX_snakraws_factevents_useragent
ON snakraws_factevents
  (useragent_id);

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_longurl_id
FOREIGN KEY (longurl_id)
REFERENCES snakraws_longurls (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_shorturl_id
FOREIGN KEY (shorturl_id)
REFERENCES snakraws_shorturls (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_city_id
FOREIGN KEY (city_id)
REFERENCES snakraws_dimcities (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_country_id
FOREIGN KEY (country_id)
REFERENCES snakraws_dimcountries (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_continent_id
FOREIGN KEY (continent_id)
REFERENCES snakraws_dimcontinents (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_region_id
FOREIGN KEY (region_id)
REFERENCES snakraws_dimregions (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_postalcode_id
FOREIGN KEY (postalcode_id)
REFERENCES snakraws_dimpostalcodes (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_device_id
FOREIGN KEY (device_id)
REFERENCES snakraws_dimdevices (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_host_id
FOREIGN KEY (host_id)
REFERENCES snakraws_dimhosts (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_referer_id
FOREIGN KEY (referer_id)
REFERENCES snakraws_dimreferers (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_ip_id
FOREIGN KEY (ip_id)
REFERENCES snakraws_dimips (id) ON DELETE NO ACTION;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_factevents_useragent_id
FOREIGN KEY (useragent_id)
REFERENCES snakraws_dimuseragents (id) ON DELETE NO ACTION;

CREATE TABLE snakraws_blacklist (
  id               INT          PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  created_on       TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  is_active        BOOLEAN NOT NULL DEFAULT TRUE,
  city_id          INT NULL ,
  continent_id     INT NULL ,
  country_id       INT NULL ,
  device_id        INT NULL ,
  host_id          INT NULL ,
  ip_id            INT NULL ,
  postalcode_id    INT NULL ,
  referer_id       INT NULL ,
  region_id        INT NULL ,
  useragent_id     INT NULL ,
  CHECK (
    (city_id IS NOT NULL AND city_id <> 0) OR
    (continent_id IS NOT NULL AND continent_id <> 0) OR
    (country_id IS NOT NULL AND country_id <> 0) OR
    (device_id IS NOT NULL AND device_id <> 0) OR
    (host_id IS NOT NULL AND host_id <> 0) OR
    (ip_id IS NOT NULL AND ip_id <> 0) OR
    (postalcode_id IS NOT NULL AND postalcode_id <> 0) OR
    (referer_id IS NOT NULL AND referer_id <> 0) OR
    (region_id IS NOT NULL AND region_id <> 0) OR
    (useragent_id IS NOT NULL AND useragent_id <> 0)
    )
);

CREATE UNIQUE INDEX UX_snakraws_blacklist_by_geo
  ON snakraws_blacklist (
    continent_id ,
    country_id ,
    region_id ,
    city_id ,
    postalcode_id  ,
    ip_id   ,
    useragent_id,
    device_id ,
    referer_id ,
    host_id
  );

CREATE UNIQUE INDEX UX_snakraws_blacklist_by_technographics
  ON snakraws_blacklist (
    ip_id,
    useragent_id,
    device_id,
    referer_id ,
    host_id,
    continent_id ,
    country_id ,
    region_id ,
    city_id ,
    postalcode_id
  );

/*
ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_city_id
FOREIGN KEY (city)
REFERENCES snakraws_dimcities (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_country_id
FOREIGN KEY (country_id)
REFERENCES snakraws_dimcountries (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_continent_id
FOREIGN KEY (continent)
REFERENCES snakraws_dimcontinents (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_region_id
FOREIGN KEY (region_id)
REFERENCES snakraws_dimregions (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_postalcode_id
FOREIGN KEY (postalcode_id)
REFERENCES snakraws_dimpostalcodes (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_device_id
FOREIGN KEY (device_id)
REFERENCES snakraws_dimdevices (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_host_id
FOREIGN KEY (host_id)
REFERENCES snakraws_dimhosts (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_referer_id
FOREIGN KEY (referer_id)
REFERENCES snakraws_dimreferers (id) ON DELETE CASCADE;

ALTER TABLE snakraws_blacklist ADD CONSTRAINT fk_snakraws_blacklist_ip_id
FOREIGN KEY (ip_id)
REFERENCES snakraws_dimips (id) ON DELETE CASCADE;

ALTER TABLE snakraws_factevents ADD CONSTRAINT fk_snakraws_blacklist_useragent_id
FOREIGN KEY (useragent_id)
REFERENCES snakraws_dimuseragents (id) ON DELETE CASCADE;
*/


CREATE INDEX IX_snakraws_blacklist_city
ON snakraws_blacklist
  (city_id);

CREATE INDEX IX_snakraws_blacklist_continent
ON snakraws_blacklist
  (continent_id);

CREATE INDEX IX_snakraws_blacklist_country
ON snakraws_blacklist
  (country_id);

CREATE INDEX IX_snakraws_blacklist_device
ON snakraws_blacklist
  (device_id);

CREATE INDEX IX_snakraws_blacklist_host
ON snakraws_blacklist
  (host_id);

CREATE INDEX IX_snakraws_blacklist_ip
ON snakraws_blacklist
  (ip_id);

CREATE INDEX IX_snakraws_blacklist_postalcode
ON snakraws_blacklist
  (postalcode_id);

CREATE INDEX IX_snakraws_blacklist_referer
ON snakraws_blacklist
  (referer_id);

CREATE INDEX IX_snakraws_blacklist_region
ON snakraws_blacklist
  (region_id);

CREATE INDEX IX_snakraws_blacklist_useragent
ON snakraws_blacklist
  (useragent_id);